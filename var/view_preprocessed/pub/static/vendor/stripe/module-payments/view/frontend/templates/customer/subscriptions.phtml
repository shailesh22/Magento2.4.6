<?php $subscriptions = $block->getActiveSubscriptions(); $paymentMethods = $block->getCustomerPaymentMethods(); $canceledSubscriptions = $block->getCanceledSubscriptions(); /** @var \StripeIntegration\Payments\Block\Customer $block */ if (empty($subscriptions)): ?> <div class="message info empty"><span><?= __("You do not have any active subscriptions."); ?></span></div><?php if (!empty($canceledSubscriptions)): ?> <div class="table-wrapper stripe-subscriptions"><table class="data table table-order-items history" id="my-orders-table"><?= $block->getCanceledSubscriptionsHtml(); ?></table></div><?php endif; ?> <?php else: ?> <div class="table-wrapper stripe-subscriptions"><table class="data table table-order-items history" id="my-orders-table"><caption class="table-caption"><?= __("Subscriptions"); ?></caption><thead><tr><th scope="col" class="col order"><?= __("Order #"); ?></th><th scope="col" class="col id"><?= __("Subscription"); ?></th><th scope="col" class="col status"><?= __("Actions"); ?></th></tr></thead><tbody><?php foreach ($subscriptions as $subscription): ?> <?php /** @var \StripeIntegration\Payments\Model\Stripe\Subscription $stripeSubscriptionModel */ $stripeSubscriptionModel = $block->getSubscriptionModel($subscription); ?> <tr class="<?= $subscription->id; ?>"><td data-th="Order #" class="col order"><a href="viewOrder/<?= $subscription->metadata["Order #"]; ?>"><?= $subscription->metadata["Order #"]; ?></a></td><td data-th="<?= __("Subscription"); ?>" class="col id"><div class="subscription-name"><?= $block->getSubscriptionName($subscription); ?></div><div class="billed"><?= $stripeSubscriptionModel->getFormattedBilling(); ?></div><div class="<?= $subscription->id; ?> payment-method stripe-subscription-edit"><div class="static section"><div class="details stripe-payments"><?php $paymentMethod = $block->getSubscriptionDefaultPaymentMethod($subscription); ?> <?php if ($paymentMethod): ?> <img class="icon" src="<?= $paymentMethod['icon']; ?>" alt="<?= $paymentMethod['label']; ?>"><span class="label"><?= $paymentMethod['label']; ?></span> <?php if (!empty($paymentMethod['exp_month'])): ?> <span class="exp"><?= $paymentMethod['exp_month']; ?>/<?= $paymentMethod['exp_year']; ?></span> <?php endif; ?> <?php else: ?> <?= __("No payment method."); ?> <?php endif; ?></div></div><div class="mutable section"><b><?= __("Select a payment method:"); ?></b><br> <form action="changeCard/<?= $subscription->id; ?>" method="POST"><div class="details"><?php $paymentMethodId = $block->getSubscriptionPaymentMethodId($subscription); ?> <?php foreach ($paymentMethods as $paymentMethod): ?> <div class="subscription-card stripe-payments"><input type="radio" id="<?= $subscription->id . "_" . $paymentMethod['id']; ?>" name="subscription_card" value="<?= $paymentMethod['id']; ?>" <?php if ($paymentMethodId == $paymentMethod['id']) echo "checked"; ?>><label for="<?= $subscription->id . "_" . $paymentMethod['id']; ?>"><img class="icon" src="<?= $paymentMethod['icon']; ?>" alt="<?= $paymentMethod['label']; ?>"><span class="label"><?= $paymentMethod['label']; ?></span> <?php if (!empty($paymentMethod['exp_month'])): ?> <span class="exp"><?= $paymentMethod['exp_month']; ?>/<?= $paymentMethod['exp_year']; ?></span> <?php endif; ?></label></div><?php endforeach; ?></div><div class="actions"><button type="submit" class="action primary"><?= __("Save"); ?></button> <button type="button" onclick="cancelEditSubscription('<?= $subscription->id; ?>')"><?= __("Cancel"); ?></button> <?= __("or"); ?> <a href="<?= $block->getUrl('stripe/customer/paymentmethods'); ?>"><?= __("add a new method"); ?></a></div></form></div></div></td><td data-th="Actions" class="col"><div class="stripe-actions-dropdown"><span class="action toggle" data-toggle="dropdown" aria-haspopup="true" data-mage-init='{"dropdown":{}}' ><span> <svg aria-hidden="true" class="SVGInline-svg SVGInline--cleaned-svg SVG-svg Icon-svg Icon--more-svg Button-icon-svg Icon-color-svg Icon-color--inherit-svg" height="16" width="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M2 10a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm6 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm6 0a2 2 0 1 1 0-4 2 2 0 0 1 0 4z" fill-rule="evenodd"></path></svg></span></span> <ul class="dropdown-options" data-target="dropdown"><?php if ($stripeSubscriptionModel->canUpgradeDowngrade()): ?> <li> <a class="item" href="<?= $stripeSubscriptionModel->editUrl(); ?>"><?= __("Change subscription"); ?></a></li> <?php endif; ?> <li> <span class="item" onclick="javascript:editSubscription('<?= $subscription->id; ?>', 'payment-method')"><a href="javascript:void(0);"><?= __("Change payment method"); ?></a></span></li> <?php if ($stripeSubscriptionModel->canChangeShipping()): ?> <li> <span class="item"><a href="<?= $block->getUrl('stripe/customer/subscriptions/changeShipping/' . $subscription->id); ?>"><?= __("Change shipping details"); ?></a></span></li> <?php endif; ?> <li class="cancel"><span class="item"><a href="cancel/<?= $subscription->id; ?>" class="action delete" onclick="return confirm('<?= __("Are you sure you want to cancel this subscription?"); ?>');"><?= __("Cancel subscription"); ?></a></span></li></ul></div></td></tr><?php endforeach; ?> <?= $block->getCanceledSubscriptionsHtml(); ?></tbody></table></div><?php endif; ?> <script type="application/javascript">

    var editSubscription = function(subscriptionId, section)
    {
        jQuery('.stripe-subscription-edit .mutable.section', 'tr.'+subscriptionId).hide();
        jQuery('.stripe-subscription-edit.'+section+'.'+subscriptionId+' .mutable.section', 'tr.'+subscriptionId).show();
        jQuery('.stripe-subscription-edit.'+subscriptionId+' .static.section', 'tr.'+subscriptionId).hide();
    };

    var cancelEditSubscription = function(subscriptionId)
    {
        jQuery('.stripe-subscription-edit.'+subscriptionId+' .mutable.section', 'tr.'+subscriptionId).hide();
        jQuery('.stripe-subscription-edit.'+subscriptionId+' .static.section', 'tr.'+subscriptionId).show();
    };

    require(['domReady!', 'jquery', 'mage/translate', 'Magento_Customer/js/customer-data', 'mage/mage'], function(domReady, $, $t, customerData)
    {
      customerData.initStorage();
      customerData.invalidate(['cart', 'cart-data', 'checkout-data']);
      

      $("button.update").click(function(e){
        customerData.invalidate(['cart']);
        
      });
    });</script>